SELECT "logoPlanID", "policyID", "pbp", "cmsContractNumber", "carrier", "account", "group", "displayPlanName", "validFrom", "validTill", plan."createdAt", plan."createdBy", plan."updatedAt", plan."updatedBy", "isDefaultLogo", "s3LogoName" AS "logoName", "s3LogoURL" AS "logoURL", CASE -- CMS/PBP NO DEFAULT WHEN (LOWER(coalesce("cmsContractNumber",'')) = coalesce('h2293','') AND LOWER(coalesce("pbp",'')) = coalesce('001','') AND coalesce("cmsContractNumber",'') <> '' AND coalesce("pbp",'') <> '' AND "isDefaultLogo" = false) THEN 1  WHEN (LOWER(coalesce("cmsContractNumber",'')) = coalesce('h2293','') AND coalesce("pbp",'') = '' AND coalesce("cmsContractNumber",'') <> '' AND "isDefaultLogo" = false) THEN 2  -- CAG NO DEFAULT WHEN (LOWER(coalesce("carrier",'')) = coalesce('773b','') AND LOWER(coalesce("account",'')) = coalesce('ivl-mapd-ppo','') AND LOWER(coalesce("group",'')) = coalesce('1667447455','') AND coalesce("carrier",'') <> '' AND coalesce("account",'') <> '' AND coalesce("group",'') <> '' AND "isDefaultLogo" = false) THEN 3  WHEN (LOWER(coalesce("carrier",'')) = coalesce('773b','') AND LOWER(coalesce("account",'')) = coalesce('ivl-mapd-ppo','') AND coalesce("group",'') = '' AND coalesce("carrier",'') <> '' AND coalesce("account",'') <> '' AND "isDefaultLogo" = false) THEN 4  WHEN (LOWER(coalesce("carrier",'')) = coalesce('773b','') AND coalesce("account",'') = '' AND coalesce("group",'') = '' AND coalesce("carrier",'') <> '' AND "isDefaultLogo" = false) THEN 5  -- CMS/PBP DEFAULT WHEN (LOWER(coalesce("cmsContractNumber",'')) = coalesce('h2293','') AND LOWER(coalesce("pbp",'')) = coalesce('001','') AND coalesce("cmsContractNumber",'') <> '' AND coalesce("pbp",'') <> '' AND "isDefaultLogo" = true) THEN 6  WHEN (LOWER(coalesce("cmsContractNumber",'')) = coalesce('h2293','') AND coalesce("cmsContractNumber",'') <> '' AND "isDefaultLogo" = true) THEN 7  -- CAG DEFAULT WHEN (LOWER(coalesce("carrier",'')) = coalesce('773b','') AND LOWER(coalesce("account",'')) = coalesce('ivl-mapd-ppo','') AND coalesce("carrier",'') <> '' AND coalesce("account",'') <> '' AND "isDefaultLogo" = true) THEN 8  WHEN (LOWER(coalesce("carrier",'')) = coalesce('773b','') AND coalesce("carrier",'') <> '' AND "isDefaultLogo" = true) THEN 9  -- ALL EXACT NO DEFAULT WHEN (LOWER(coalesce("cmsContractNumber",'')) = coalesce('h2293','') AND LOWER(coalesce("pbp",'')) = coalesce('001','') AND LOWER(coalesce("carrier",'')) = coalesce('773b','') AND LOWER(coalesce("account",'')) = coalesce('ivl-mapd-ppo','') AND LOWER(coalesce("group",'')) = coalesce('1667447455','') AND "isDefaultLogo" = false) THEN 10  -- ALL NULL DEFAULT WHEN (coalesce("cmsContractNumber",'') = '' AND coalesce("pbp",'') = '' AND coalesce("carrier",'') = '' AND coalesce("account",'') = '' AND coalesce("group",'') = '' AND "isDefaultLogo" = true) THEN 11  -- NEW HIERARCHY CASES FOR NON DEFAULT PLANS WHEN (LOWER(coalesce("cmsContractNumber",'')) = coalesce('h2293','') AND coalesce("cmsContractNumber",'') <> '' AND "isDefaultLogo" = false) THEN 12 WHEN (LOWER(coalesce("pbp",'')) = coalesce('001','') AND coalesce("pbp",'') <> '' AND "isDefaultLogo" = false) THEN 13 WHEN (LOWER(coalesce("account",'')) = coalesce('ivl-mapd-ppo','') AND LOWER(coalesce("carrier",'')) = coalesce('773b','') AND coalesce("carrier",'') <> '' AND coalesce("account",'') <> '' AND "isDefaultLogo" = false) THEN 14 WHEN (LOWER(coalesce("group",'')) = coalesce('1667447455','') AND LOWER(coalesce("carrier",'')) = coalesce('773b','') AND coalesce("carrier",'') <> '' AND coalesce("group",'') <> '' AND "isDefaultLogo" = false) THEN 15 WHEN (LOWER(coalesce("carrier",'')) = coalesce('773b','') AND coalesce("carrier",'') <> '' AND "isDefaultLogo" = false) THEN 16 WHEN (LOWER(coalesce("account",'')) = coalesce('ivl-mapd-ppo','') AND LOWER(coalesce("group",'')) = coalesce('1667447455','') AND coalesce("group",'') <> '' AND coalesce("account",'') <> '' AND "isDefaultLogo" = false) THEN 17 WHEN (LOWER(coalesce("account",'')) = coalesce('ivl-mapd-ppo','') AND coalesce("account",'') <> '' AND "isDefaultLogo" = false) THEN 18 WHEN (LOWER(coalesce("group",'')) = coalesce('1667447455','') AND coalesce("group",'') <> '' AND "isDefaultLogo" = false) THEN 19 ELSE 20 END AS "sortRank" FROM policy."PolicyLogoPlans" AS plan INNER JOIN policy."PolicyS3LogoMapping" AS mapper ON plan."policyS3LogoMappingID" = mapper."s3LogoMappingID" INNER JOIN policy."PolicyS3Logos" AS s3 ON mapper."policyS3LogoID" = s3."policyS3LogoID" WHERE "policyID" = 1886 AND "validFrom" <= NOW() AND ("validTill" ISNULL OR "validTill" >= NOW()) AND "isDeleted" = false ORDER BY "sortRank" LIMIT 1;
